{% extends "base.html" %}

{% block title %}Analyze Token - Sonic's Risk Switch{% endblock %}
{% block analyze_active %}active{% endblock %}

{% block content %}

<div class="container mt-2">
    <label for="token-dropdown" class="form-label"><b>Select a Token:</b></label>
    <div class="input-group mb-3">
        <select id="token-dropdown" class="custom-select">
            <option value="" selected disabled>Choose a token...</option>
            {% for name, symbol in combined_tokens.items() %}
                <option value="{{ symbol }}">{{ name }} ({{ symbol }})</option>
            {% endfor %}
        </select>
    </div>

    <div id="wallet-status" class="mt-3"></div>

    <div id="payment-section" class="mt-4" style="display: none;">
        <button id="pay-with-metamask" class="btn btn-success">Pay 0.5 Sonic to Proceed</button>
    </div>

    <div id="payment-status" class="mt-3"></div>

    <div id="analysis-section" class="mt-4" style="display: none;">
        <button id="analyze-btn" class="btn btn-primary">Generate Report</button>
        <div id="analysis-result" class="mt-3"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.3/web3.min.js"></script>
<script>
    let userAccount = null;
    let provider = window.ethereum;
    const SONIC_CHAIN_ID = "0x92"; // 146 in hexadecimal
    const RECIPIENT_ADDRESS = "0x5A8eF3672fFAc8007ce2d025cebEbBAFb7F6e01B"; // Your recipient wallet

    async function checkWalletConnection() {
        if (provider) {
            const accounts = await provider.request({ method: "eth_accounts" });
            const currentChain = await provider.request({ method: "eth_chainId" });

            if (accounts.length > 0) {
                userAccount = accounts[0];

                if (currentChain !== SONIC_CHAIN_ID) {
                    promptSwitchNetwork();
                } else {
                    $("#wallet-status").html(`<div class="alert alert-success">Connected: ${userAccount}</div>`);
                    $("#payment-section").show();
                }
            } else {
                $("#wallet-status").html(`<div class="alert alert-warning">Wallet not connected. Please connect.</div>`);
                $("#payment-section").hide();
            }
        } else {
            $("#wallet-status").html(`<div class="alert alert-danger">MetaMask not found. Install MetaMask to proceed.</div>`);
        }
    }

    async function promptSwitchNetwork() {
        try {
            await provider.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: SONIC_CHAIN_ID }]
            });
            location.reload(); // Refresh to ensure correct network
        } catch (switchError) {
            console.error(switchError);
            $("#wallet-status").html(`<div class="alert alert-danger">Please switch to the Sonic Network manually.</div>`);
        }
    }

    async function payWithMetaMask() {
        if (!userAccount) {
            $("#payment-status").html(`<div class="alert alert-warning">Please connect your wallet first.</div>`);
            return;
        }

        let amountInWei = Web3.utils.toWei("0.5", "ether");

        try {
            let tx = await provider.request({
                method: "eth_sendTransaction",
                params: [{
                    from: userAccount,
                    to: RECIPIENT_ADDRESS,
                    value: Web3.utils.toHex(amountInWei),
                    gas: Web3.utils.toHex(21000)
                }]
            });

            $("#payment-status").html(`<div class="alert alert-info">Transaction sent! Tx Hash: ${tx}</div>`);
            validatePayment(tx);
        } catch (error) {
            console.error(error);
            $("#payment-status").html(`<div class="alert alert-danger">Transaction failed.</div>`);
        }
    }

    $(document).ready(function () {
        checkWalletConnection();
        $("#pay-with-metamask").click(payWithMetaMask);
    });
</script>

{% endblock %}
